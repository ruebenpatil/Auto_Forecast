<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Forecast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>

<body class="bg-gray-50 text-gray-800 font-sans min-h-screen flex flex-col">

    <!-- Header -->
    <header class="sticky top-0 bg-white shadow z-50">
        <div class="max-w-7xl mx-auto flex items-center justify-between px-6 py-5">
            <img src="{{ url_for('static', path='assets/logo.png') }}" alt="Logo" class="h-10">
            <nav class="space-x-6">
                <a href="{{ url_for('index') }}"
                    class="text-gray-700 hover:text-blue-600 transition font-medium">Home</a>
                <a href="{{ url_for('upload') }}" class="text-blue-600 font-semibold underline">Upload</a>
                <a href="/forecast.html" class="text-gray-700 hover:text-blue-600 transition font-medium">Forecast</a>
                <a href="/results.html" class="text-gray-700 hover:text-blue-600 transition font-medium">Results</a>
            </nav>
        </div>
    </header>

    <!-- Upload Section -->
     <main class="flex-grow">
    <section class="max-full mx-auto px-6 py-12">
        <h1 class="text-4xl font-bold mb-10 text-center text-blue-800">Upload Your CSV</h1>

        <!-- File Upload -->
        <div class="flex flex-col items-center mb-8">
            <input id="csvInput" type="file" accept=".csv"
            onchange="validateFile(this)"
                class="block w-full max-w-xs text-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200" />

            <!-- File size note -->
            <p class="mt-3 text-sm text-gray-600 text-center max-w-md">
                ⚠️ For best performance, please upload a CSV file under <span class="font-semibold text-blue-700">10
                    MB</span>.<br> Larger files may slow down processing.
            </p>
        </div>


        <!-- Dropdown and Run Button -->
        <div class="flex justify-center mb-8">
            <div id="optionsSection" class="hidden w-full max-w-xs space-y-4">
                <select id="frequency"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Frequency</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
                <button id="runForecast"
                    class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                    Run Forecast
                </button>
            </div>
        </div>


        <!-- Spinner -->
        <div id="spinner" class="hidden flex justify-center my-6">
            <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
            </svg>
        </div>

        <!-- Scores Section -->
        <div class="flex justify-center mt-8" id="resultsWrapper">
            <div id="results" class="w-full max-w-4xl hidden">
                <h2 class="text-3xl font-semibold mb-4 text-center">Forecast Results</h2>
                <div id="tableContainer" class="flex justify-center flex-wrap gap-6">
                    <!-- Tables will be dynamically inserted here -->
                </div>
            </div>
        </div>

        <!-- Best Model Display -->
        <div id="bestModelWrapper" class="w-full text-center mt-6 hidden">
            <p id="bestModelText" class="text-2xl font-medium text-green-600">
                <!-- Best model info will go here -->
            </p>
        </div>


        <!-- Model Selection -->
        <div class="flex justify-center mt-8" id="modelSectionWrapper">
            <div id="modelSection" class="w-full max-w-md hidden">
                <h3 class="text-xl font-semibold mb-2 text-center">Select Model</h3>
                <select id="modelSelector"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select Model</option>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
        </div>

        <!-- Spinner -->
        <div id="spinner_model" class="hidden flex justify-center my-6">
            <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
            </svg>
        </div>

        <!-- Tables Section -->
        <div class="flex justify-center mt-8" id="resultsWrapper">
            <div id="modelResults" class="w-full max-w-7xl hidden">
                <!-- <h2 class="text-2xl font-semibold mb-4 text-center">Forecast Results</h2> -->
                <div id="modelTableContainer" class="flex justify-center flex-wrap gap-6">
                    <!-- JS will insert tables here -->
                </div>
            </div>
        </div>

        <!-- Charts Section (Bottom Row) -->
        <div id="chartContainer" class="mt-8 hidden grid grid-cols-1 md:grid-cols-2 gap-6 max-w-6xl mx-auto">
            <!-- Chart 1 -->
            <div id="chart3" class="bg-white p-4 shadow rounded">
                <h4 class="text-center font-semibold mb-2">Actual vs Forecast with Confidence Interval</h4>
                <svg id="currentChart" width="100%" height="300"></svg>
            </div>

            <!-- Chart 2 -->
            <div id="chart4" class="bg-white p-4 shadow rounded">
                <h4 class="text-center font-semibold mb-2">Future Forecast with Confidence Interval</h4>
                <svg id="futureChart" width="100%" height="300"></svg>
            </div>
        </div>

    </section>
    </main>

    <footer class="bg-gray-900 text-white py-6 mt-10">
      <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between px-6">
        <div class="flex items-center space-x-3">
          <svg class="w-6 h-6 text-blue-400" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.477 2 2 6.484 2 12.014c0 4.419 2.865 8.166 6.839 9.489.5.092.682-.219.682-.484 0-.238-.008-.868-.013-1.703-2.782.605-3.37-1.34-3.37-1.34-.454-1.153-1.11-1.46-1.11-1.46-.909-.62.069-.608.069-.608 1.003.071 1.531 1.03 1.531 1.03.893 1.532 2.341 1.09 2.91.833.091-.647.35-1.091.636-1.342-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.27.098-2.647 0 0 .84-.27 2.75 1.026A9.574 9.574 0 0112 6.844c.85.004 1.704.115 2.5.337 1.909-1.296 2.748-1.026 2.748-1.026.546 1.377.202 2.394.099 2.647.64.7 1.028 1.595 1.028 2.688 0 3.848-2.337 4.696-4.566 4.944.359.31.679.924.679 1.861 0 1.343-.012 2.427-.012 2.756 0 .268.18.58.688.481A10.018 10.018 0 0022 12.014C22 6.484 17.523 2 12 2z"/>
          </svg>
          <span class="text-lg font-semibold">Made by <span class="text-blue-400">Rueben Patil</span></span>
        </div>
        <div class="mt-4 md:mt-0">
          <a href="https://www.linkedin.com/in/rueben-patil-3b14b91b3?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" class="flex items-center text-blue-400 hover:text-white transition">
            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24">
              <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.762 2.239 5 5 5h14c2.761 0 5-2.238 5-5v-14c0-2.761-2.239-5-5-5zm-11 19h-3v-9h3v9zm-1.5-10.286c-.966 0-1.75-.792-1.75-1.764 0-.973.784-1.765 1.75-1.765s1.75.792 1.75 1.765c0 .972-.784 1.764-1.75 1.764zm13.5 10.286h-3v-4.586c0-2.418-3-2.231-3 0v4.586h-3v-9h3v1.192c1.396-2.586 6-2.777 6 2.476v5.332z"/>
            </svg>
            Connect on LinkedIn
          </a>
        </div>
      </div>
    </footer>

    <script>
        function validateFile(input) {
            const maxSizeMB = 10;
            const file = input.files[0];
            if (file && file.size > maxSizeMB * 1024 * 1024) {
                alert("File is too large! Please upload a file under 10 MB.");
                input.value = ""; // Reset file input
            }
        }
    </script>

    <script type="text/javascript" src="{{ url_for('static', path='js/currentChart.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', path='js/futureChart.js') }}"></script>

    <!-- Script -->
    <script>
        const csvInput = document.getElementById('csvInput');
        const optionsSection = document.getElementById('optionsSection');
        const runForecast = document.getElementById('runForecast');
        const spinner = document.getElementById('spinner');
        const spinnerModel = document.getElementById('spinner_model');
        const results = document.getElementById('results');
        const tableContainer = document.getElementById('tableContainer');
        const modelSection = document.getElementById('modelSection');
        const modelSelector = document.getElementById('modelSelector');

        let uploadedFile;

        csvInput.addEventListener('change', (e) => {
            uploadedFile = e.target.files[0];
            if (uploadedFile) {
                optionsSection.classList.remove('hidden');
            } else {
                optionsSection.classList.add('hidden');
            }
        });

        runForecast.addEventListener('click', async () => {
            const frequency = document.getElementById('frequency').value;
            if (!uploadedFile || !frequency) return alert('Please upload a file and select frequency.');

            spinner.classList.remove('hidden');
            results.classList.add('hidden');
            tableContainer.innerHTML = '';

            const formData = new FormData();
            formData.append('file', uploadedFile);
            formData.append('frequency', frequency);

            try {
                const response = await fetch('/api/forecast', {
                    method: 'POST',
                    body: formData,
                    credentials: "include"
                });
                const data = await response.json();

                const sessionKey = data.session_key;

                sessionStorage.setItem("session_key", sessionKey);

                const resultsWrapper = document.getElementById('results');
                resultsWrapper.classList.remove('hidden');

                // Clear any previous tables
                const tableContainer = document.getElementById('tableContainer');
                tableContainer.innerHTML = '';

                // Apply layout classes
                tableContainer.className = 'flex flex-wrap gap-6 justify-center';

                data.tables.forEach((table, index) => {
                    // Create a column wrapper for each table + title
                    const colWrapper = document.createElement('div');
                    colWrapper.className = 'w-full md:w-[45%]';

                    // Add a title above the table
                    const title = document.createElement('h3');
                    title.textContent = table.title || "Scores";
                    title.className = 'text-lg font-semibold mb-2 text-center';

                    // Create the table wrapper and table element
                    const tableWrapper = document.createElement('div');
                    tableWrapper.className = 'w-full bg-white shadow-sm rounded overflow-x-auto';

                    const tableEl = document.createElement('table');
                    tableEl.className = 'w-full';

                    const thead = '<thead><tr>' + table.headers.map(h =>
                        `<th class="text-left p-2 border-b font-medium">${h}</th>`).join('') + '</tr></thead>';
                    const tbody = '<tbody>' + table.rows.map(row =>
                        '<tr>' + row.map(cell => `<td class="p-2 border-b">${cell}</td>`).join('') + '</tr>').join('') + '</tbody>';

                    tableEl.innerHTML = thead + tbody;

                    // Assemble the column
                    tableWrapper.appendChild(tableEl);
                    colWrapper.appendChild(title);
                    colWrapper.appendChild(tableWrapper);
                    tableContainer.appendChild(colWrapper);
                });

                const bestModelWrapper = document.getElementById("bestModelWrapper");
                const bestModelText = document.getElementById("bestModelText");

                bestModelText.textContent = data.top_model_text;
                bestModelWrapper.classList.remove("hidden");
                // Inside runForecast.addEventListener AFTER rendering tables:
                if (data.models && data.models.length > 0) {
                    const filteredModels = data.models;

                    if (filteredModels.length > 0) {
                        modelSelector.innerHTML = '<option value="">Select Model</option>' +
                            filteredModels.map(model => `<option value="${model}">${model}</option>`).join('');
                        modelSection.classList.remove('hidden');
                    } else {
                        modelSelector.innerHTML = '';
                        modelSection.classList.add('hidden');
                    }
                }

                spinner.classList.add('hidden');

                modelSelector.addEventListener("change", async () => {
                    const selectedModel = modelSelector.value;
                    if (!selectedModel) return;
                    spinnerModel.classList.remove('hidden');
                    chartContainer.classList.add('hidden');
                    try {
                        const sessionKeyNew = sessionStorage.getItem("session_key");
                        console.log(sessionKeyNew);
                        const response = await fetch(`/api/forecast/${selectedModel}?session_key=${sessionKeyNew}`,
                            { method: 'GET', credentials: "include" });
                        const modelData = await response.json();

                        const resultsWrapper = document.getElementById('modelResults');
                        resultsWrapper.classList.remove('hidden');

                        // Clear any previous tables
                        const tableContainer = document.getElementById('modelTableContainer');
                        tableContainer.innerHTML = '';

                        // Apply layout classes
                        tableContainer.className = 'flex flex-wrap gap-6 justify-center';

                        modelData.tables.forEach((table, index) => {
                            // Create a column wrapper for each table + title
                            const colWrapper = document.createElement('div');
                            colWrapper.className = 'w-full md:w-[45%]';

                            // Add a title above the table
                            const title = document.createElement('h3');
                            title.textContent = table.title || "Scores";
                            title.className = 'text-lg font-semibold mb-2 text-center';

                            // Create the table wrapper and table element
                            const tableWrapper = document.createElement('div');
                            tableWrapper.className = 'w-full bg-white shadow-sm rounded overflow-x-auto';

                            const tableEl = document.createElement('table');
                            tableEl.className = 'w-full';

                            const thead = '<thead><tr>' + table.headers.map(h =>
                                `<th class="text-left p-2 border-b font-medium">${h}</th>`).join('') + '</tr></thead>';
                            const tbody = '<tbody>' + table.rows.map(row =>
                                '<tr>' + row.map(cell => `<td class="p-2 border-b">${cell}</td>`).join('') + '</tr>').join('') + '</tbody>';

                            tableEl.innerHTML = thead + tbody;

                            // Assemble the column
                            tableWrapper.appendChild(tableEl);
                            colWrapper.appendChild(title);
                            colWrapper.appendChild(tableWrapper);
                            tableContainer.appendChild(colWrapper);
                        });

                        const currentItem = modelData.tables.filter(d => d.type === "current")[0];
                        const futureItem = modelData.tables.filter(d => d.type === "future")[0];
                        drawCurrentForecastChart(currentItem, "#currentChart");
                        drawFutureForecastChart("#futureChart", currentItem, futureItem);

                        chartContainer.classList.remove('hidden');
                    } catch (error) {
                        alert('Error loading the model');
                        console.error(error);
                    } finally {
                        spinnerModel.classList.add('hidden');
                    }
                })
                results.classList.remove('hidden');
            } catch (error) {
                alert('Error running forecast.');
                console.error(error);
            } finally {
                spinner.classList.add('hidden');
            }
        });
    </script>
</body>

</html>